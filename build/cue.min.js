const a=window.localStorage,b=new Map,c={fetch(a,b=86400,c){return new Promise((g,h)=>{const i=e(a);null===i?f(a,"GET",c).then(c=>{d(a,c,b),g(JSON.parse(c))}).catch(a=>{h(a)}):g(JSON.parse(i))})},post(a,b,c){return new Promise((d,e)=>{f(a,"POST",c,b).then(a=>d(JSON.parse(a))).catch(a=>e(a))})}};function d(b,c,d){const e=Date.now();"object"==typeof c&&(c=JSON.stringify(c)),a.setItem(b,c),a.setItem(`${b}::ts`,e+1e3*d)}function e(b){const c=a.getItem(`${b}::ts`);return null===c?null:c<Date.now()?(a.removeItem(b),a.removeItem(`${b}::ts`),null):a.getItem(b)}function f(a,c,d,e={}){if(b.has(a))return b.get(a);else{const f={"Content-Type":"application/json"};d&&(f.Authorization=`Bearer ${d}`);const g=new Promise((d,h)=>{b.set(a,g);fetch(a,{method:c,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:f,redirect:"follow",referrer:"no-referrer",body:"GET"===c?null:JSON.stringify(e)}).then(c=>{c.json().then(c=>{b.delete(a),d(c)})}).catch(c=>{b.delete(a),h(c)})});return g}}const g=()=>{};function h(c,a){return Array.isArray(c)?!!(Array.isArray(a)&&c.length===a.length)&&n(c,a):"object"==typeof c?"object"==typeof a&&(null!==c&&null!==a||c===a)&&m(c,a):c===a}function i(a){return Array.isArray(a)?q(a):p(a)}function j(c,a){for(let b=0;b<c.length;b++)if(c[b]!==a[b])return!1;return!0}function k(c,a){const b=Object.keys(c),d=Object.keys(a);if(b.length!==d.length)return!1;for(let e,f=0;f<b.length;f++)if(e=b[f],-1===d.indexOf(e)||c[e]!==a[e])return!1;return!0}function l(a){return"function"==typeof a?a:g}function m(c,a){const b=Object.keys(c),d=Object.keys(a);if(b.length!==d.length)return!1;for(let e,f=0;f<b.length;f++)if(e=b[f],-1===d.indexOf(e)||!h(c[e],a[d[f]]))return!1;return!0}function n(c,a){for(let b=0;b<c.length;b++)if(!h(c[b],a[b]))return!1;return!0}function p(a){const b={},c=Object.keys(a);for(let d,e,f=0;f<c.length;f++)d=c[f],e=a[d],b[d]=e?Array.isArray(e)?q(e):"object"==typeof e?p(e):e:e;return b}function q(b){const a=[];for(let c,d=0;d<b.length;d++)c=b[d],a[d]=c?Array.isArray(c)?q(c):"object"==typeof c?p(c):c:c;return a}const r=new Map,s=window.localStorage,t="VCS::",u=`${t}PARSE::`,v=u.length,w=`${t}ALL_KEYS`,x={get(a){if(!a){const a={},b=s.getItem(w);if(null!==b){const c=b.split(",");for(let b=0;b<c.length;b++){const d=s.getItem(`${t}${c[b]}`);a[c[b]]=y(d)?JSON.parse(d.substring(v)):d}}return a}const b=a.split("/"),c=s.getItem(`${t}${b[0]}`);if(null===c)return null;if(!y(c))return c;const d=JSON.parse(c.substring(v));if(1<b.length){const[a,c]=A(d,b);return a[c]}return d},set(a,b){if(1===arguments.length){if("object"!=typeof a||null===a)throw new Error("Invalid arguments provided to Store.set...");for(const b in this.clear(!0),a)this.set(b,a[b]);return!0}const c=a.split("/"),d=`${t}${c[0]}`,e=s.getItem(d);if(1<c.length){if(y(e)){const f=JSON.parse(e.substring(v)),[g,i]=A(f,c);return!h(g[i],b)&&(g[i]=b,s.setItem(d,`${u}${JSON.stringify(f,z)}`),B(a,b,c,f),!0)}throw new Error(`Cannot set property at path: "${a}" because the current value is stored as a string.`)}if(null===e){"string"==typeof b?s.setItem(d,b):s.setItem(d,`${u}${JSON.stringify(b)}`);let c=s.getItem(w);return null===c?c=`${d},`:-1===c.indexOf(`${d},`)&&(c=`${c}${d},`),s.setItem(w,c),C(a,b),!0}if(y(e)){const c=JSON.parse(e.substring(v));return!h(c,b)&&(s.setItem(d,`${u}${JSON.stringify(b,z)}`),C(a,b),!0)}return e!==b&&(s.setItem(d,`${JSON.stringify(b,z)}`),C(a,b),!0)},has(a){const b=a.split("/"),c=s.getItem(`${t}${b[0]}`);if(1<b.length){if(!1===y(c))return!1;try{return A(JSON.parse(c.substring(v)),b),!0}catch(a){return!1}}else return null!==c},remove(a){const b=a.split("/"),c=`${t}${b[0]}`,d=s.getItem(c);if(null!==d)if(!(1<b.length)){s.removeItem(c);const b=s.getItem(w).split(",");b.splice(b.indexOf(c),1),s.setItem(w,`${b.join(",")},`),C(a,void 0)}else if(!0===y(d)){const e=JSON.parse(d.substring(v)),[f,g]=A(e,b);Array.isArray(f)?f.splice(parseInt(g),1):delete f[g],s.setItem(c,`${u}${JSON.stringify(e,z)}`),B(a,void 0,b,e)}else throw new Error(`Cannot delete property at path: "${a}" because the current value is stored as a string.`)},clear(a=!1){const b=s.getItem(w);if(null!==b){const c=b.split(",");for(let b=0;b<c.length;b++)s.removeItem(c[b]),!1===a&&C(c[b],void 0);s.removeItem(w)}},bind(a,b){return{id:this.id,path:a,defaultValue:b}},subscribe(a,b,c={}){if("string"!=typeof a||"function"!=typeof b||null===c||"object"!=typeof c)throw new Error(`Invalid arguments. Expect (path:String, handler:Function, [options:Object]`);const d=Object.assign({scope:null,bubbles:!1},c,{handler:b});return r.has(a)?r.get(a).push(d):r.set(a,[d]),{unsubscribe(){const b=r.get(a);b.splice(b.indexOf(d),1),0===b.length&&r.delete(a)}}}};Object.defineProperty(x,"id",{value:Symbol("Store ID")});function y(a){for(let b=0;b<v;b++)if(a[b]!==u[b])return!1;return!0}function z(a,b){return b===void 0?null:b}function A(a,b){if(null!==a&&"object"==typeof a){let c,d;for(let e=1;e<b.length;e++)d=b[e],c=1==e?a:c[b[e-1]];if(c.hasOwnProperty(d))return[c,d];throw new Error(`Can not access store path: "${b.join("/")}". Property ".../${d}" does not exist.`)}else throw new Error(`Can not access store path: "${b.join("/")}". The value stored at: "${b[0]}" is not object or array.`)}function B(a,b,c,d){let f=r.get(a);if(f&&f.length){let a,g,h,i,e=!1;for(a=0;a<f.length;a++)if(!0===f[a].bubbles){e=!0;break}if(!0==e){const b=[];let e=c[0],f=d,j=r.get(e);if(j&&j.length)for(a=0;a<j.length;a++)b.push([j[a],d]);for(a=1;a<c.length;a++)if(e+=`/${c[a]}`,f=f[c[a]],j=r.get(e),j&&j.length)for(g=0;g<j.length;g++)b.push([j[g],f]);for(a=b.length-1;0<=a;a--)h=b[a],i=h[0],i.handler.call(i.scope,h[1])}else for(a=0;a<f.length;a++)i=f[a],i.handler.call(i.scope,b)}}function C(a,b){const c=r.get(a);if(c&&c.length)for(let a,d=0;d<c.length;d++)a=c[d],a.handler.call(a.scope,b)}const D=-1,E=0,F=1,G=2,H={computedProperty:null,computedProperties:null};let I=null,J=[];class K{constructor(a,b,c=[]){this.ownPropertyName=a,this.computation=b,this.sourceProperties=c,this.intermediate=void 0,this._value=void 0,this._type=D,this.needsUpdate=!0,this.hasChanged=!1}value(a){return!0===this.needsUpdate&&(this.intermediate=this.computation.call(a,a),Array.isArray(this.intermediate)?(this.hasChanged=this._type!==F||this.intermediate.length!==this._value.length||!j(this._value,this.intermediate))&&(this._value=this.intermediate.slice(),this._type=F):"object"==typeof this.intermediate&&null!==this.intermediate?(this.hasChanged=this._type!==G||!k(this._value,this.intermediate))&&(this._value=Object.assign({},this.intermediate),this._type=G):(this.hasChanged=this._value!==this.intermediate)&&(this._value=this.intermediate,this._type=E),this.needsUpdate=!1),this._value}}function L(a,b){return O(N(a,b))}function M(a){const b=new Map;let c,d,e;for(c of a.values())for(d=0;d<c.sourceProperties.length;d++)e=c.sourceProperties[d],b.has(e)?b.get(e).push(c):b.set(e,[c]);return b}function N(a,b){Object.assign(H,{computedProperties:b});const c=new Proxy(a,{get:P});let d;for(d of b.values()){H.computedProperty=d;try{d.computation.call(c,c)}catch(a){if(a.type&&"cue-internal"===a.type)throw new Error(a.message)}}return H.computedProperty=null,H.computedProperties=null,b}function O(a){I=a;const b=new Map;let c;for(c of a.keys())Q(c,[],b);return I=null,J=[],b}function P(a,b){const{computedProperty:c}=H;if(!a.hasOwnProperty(b))throw{type:"cue-internal",message:`Cannot resolve computed property "${c.ownPropertyName}" because dependency "${b}" doesn't exist.`};-1===c.sourceProperties.indexOf(b)&&c.sourceProperties.push(b)}function Q(a,b,c){if(I.has(a)){b.push(a),J.push(a);const d=I.get(a);for(let a,e=0;e<d.sourceProperties.length;e++){if(a=d.sourceProperties[e],-1!==b.indexOf(a))throw new Error(`Circular dependency. "${d.ownPropertyName}" is required by "${a}": ${b.join(" -> ")}`);-1===J.indexOf(a)&&Q(a,b,c)}c.has(a)||c.set(a,d)}}let R=null,S=!1;const T=new Map,U=new Map,V=new Map,W=[],X={cueCallback(a,b){T.set(a,b)},cueComputations(a,b,c,d){const e=a.get(c),f=[a,b,d];for(let g=0;g<e.length;g++)U.set(e[g],f)},react(){null===R&&!1===S&&(R=requestAnimationFrame(Y))}};function Y(){S=!0;let a,b,c,d,e,f,g,h;for(;0<U.size;){for(b of U.entries())d=b[0],-1===W.indexOf(d)&&(e=b[1],g=e[0],f=e[1],d.needsUpdate=!0,h=d.value(e[2]),!0===d.hasChanged&&(f[d.ownPropertyName]&&T.set(f[d.ownPropertyName],h),V.set(d,e)),W.push(d));U.clear();for(b of V.entries())if(d=b[0],e=b[1],c=e[0].get(d.ownPropertyName),c)for(a=0;a<c.length;a++)U.set(c[a],e);V.clear()}for(b of T.entries())b[0](b[1]);for(T.clear();0<W.length;)W.pop();R=null,S=!1}const Z="ref",$=Symbol("Component Data"),_=(()=>{const a=document.createElement("style");return a.id="cue::components",document.head.appendChild(a),a.sheet})(),aa=document.createElement("style"),ba={define(a,b){let c=null;const d=b.attributes?Object.keys(b.attributes):[],e=class extends HTMLElement{constructor(){super();let d,f;if(null===c)for(d in c=ca(a,b),e.prototype.renderEach=ea,c.methods)e.prototype[d]=c.methods[d];const g=new Map,h=i(c.data),j=this[$]={_data:h,data:new Proxy(h,{get(a,b){if(c.storeBindings[b])return x.get(c.storeBindings[b].path);if(g.has(b))return g.get(b).value(j.data);const d=a[b];return Array.isArray(d)?d.slice():"object"==typeof d&&null!==d?Object.assign({},d):d}}),computedProperties:g,reactions:{},attributeChangedCallbacks:{},subscriptions:[],refs:{},initialized:!1};for(f of c.computedProperties.entries())g.set(f[0],new K(f[1].ownPropertyName,f[1].computation,f[1].sourceProperties));for(d in j.dependencyGraph=M(j.computedProperties),c.reactions)j.reactions[d]=c.reactions[d].bind(null,j.refs);for(d in c.attributeChangedCallbacks)j.attributeChangedCallbacks[d]=c.attributeChangedCallbacks[d].bind(null,j.refs)}connectedCallback(){const b=this[$];for(const a in c.storeBindings)b.dependencyGraph.has(a)&&b.subscriptions.push(x.subscribe(c.storeBindings[a].path,()=>{X.cueComputations(b.dependencyGraph,b.reactions,a,b.data),X.react()})),b.reactions[a]&&b.subscriptions.push(x.subscribe(c.storeBindings[a].path,c=>{X.cueCallback(b.reactions[a],c),X.react()}));if(!1===b.initialized){let d,e,f;if(!0===c.encapsulated){const a=b.shadowDom=this.attachShadow({mode:"open"});for(a.innerHTML=c.styles,d=0;d<this.childNodes.length;d++)a.appendChild(this.childNodes[d]);for(d=c.template.children.length-1;0<=d;d--)a.insertBefore(c.template.children[d].cloneNode(!0),this.firstChild)}else for(d=c.template.children.length-1;0<=d;d--)this.insertBefore(c.template.children[d].cloneNode(!0),this.firstChild);for(f in da(c.encapsulated?b.shadowDom:this,b.refs,c.refNames),c.storeBindings)e=c.storeBindings[f].path,x.has(e)&&b.reactions[f]?X.cueCallback(b.reactions[f],x.get(e)):c.storeBindings[f].hasOwnProperty("defaultValue")?x.set(e,c.storeBindings[f].defaultValue):console.warn(`<${a}>.data["${f}"] is bound to Store["${e}"] but Store has no value and component specifies no default.`);for(f in b.reactions)X.cueCallback(b.reactions[f],b.data[f]);X.react(),b.initialized=!0,c.initialize.call(this,b.refs)}c.connected.call(this,b.refs)}disconnectedCallback(){for(const a=this[$].subscriptions;a.length;)a.pop().unsubscribe();c.disconnected.call(this,this[$].refs)}adoptedCallback(){c.adopted.call(this,this[$].refs)}get(a){return this[$].data[a]}set(a,b){if(c.storeBindings[a])x.set(c.storeBindings[a].path,b);else if(c.computedProperties.has(a))throw new Error(`You can not set property "${a}" because it is a computed property.`);else{const c=this[$],d=c._data[a];h(d,b)||(c._data[a]=b,c.reactions[a]&&X.cueCallback(c.reactions[a],b),c.dependencyGraph.has(a)&&X.cueComputations(c.dependencyGraph,c.reactions,a,c.data),X.react())}}static get observedAttributes(){return d}attributeChangedCallback(a,b,c){const d=this[$].attributeChangedCallbacks[a];d&&(X.cueCallback(d,c),X.react())}};return customElements.define(a,e),(b={})=>{let c="<"+a;for(const a in b)c+=` ${a}="${b[a]}"`;return c+=`></${a}>`}},create(a,b){a=a.trim();const c="<"===a[0]?document.createRange().createContextualFragment(a).firstChild:document.createElement(a);if("object"==typeof b&&null!==b)if(c[$])for(const a in b)c[$]._data.hasOwnProperty(a)?c[$]._data[a]=b[a]:console.warn(`Cannot pass data property "${a}" to component "${c.tagName}" because the property has not been explicitly defined in the components data model.`);else console.warn(`Cannot set data on element "${c.tagName}" because it has not been defined via Component.define!`);return c}};function ca(a,b){const c={encapsulated:!0===b.encapsulated,template:document.createRange().createContextualFragment(`<cue-template>${b.element.trim()}</cue-template>`).firstChild},d=c.template.querySelectorAll(`[${Z}]`);c.refNames=new Map;let e,f,g,h;for(e=0;e<d.length;e++)f=d[e].getAttribute(Z),f&&f.length&&c.refNames.set(f,`[${Z}="${f}"]`);if(c.styles="","string"==typeof b.styles&&b.styles.length){c.styles=b.styles;for(h of c.refNames.entries())c.styles=c.styles.split(h[0]).join(h[1]);if(!1===c.encapsulated){aa.innerHTML=c.styles,document.head.appendChild(aa);const b=aa.sheet;for(e=0;e<b.rules.length;e++)f=b.rules[e].selectorText,0===f.lastIndexOf(a,0)?_.insertRule(b.rules[e].cssText):0===f.lastIndexOf("self",0)?_.insertRule(b.rules[e].cssText.split("self").join(a)):_.insertRule(`${a} ${b.rules[e].cssText}`);aa.innerHTML="",document.head.removeChild(aa)}}const j={};if(b.reactions){const a=new Set;for(f in b.reactions){if(g=b.reactions[f],"function"!=typeof g)throw new Error(`Reaction "${f}" is not a function...`);if(a.has(g))throw new Error(`Reaction "${f}" already in use. You can't use the same reaction for multiple data properties.`);j[f]=g,a.add(g)}}for(f in c.methods={},b)"initialize"!==f&&"connectedCallback"!==f&&"adoptedCallback"!==f&&"disconnectedCallback"!==f&&"function"==typeof b[f]&&(c.methods[f]=b[f]);c.initialize=l(b.initialize),c.connected=l(b.connectedCallback),c.disconnected=l(b.disconnectedCallback),c.adopted=l(b.adoptedCallback),c.data={},c.storeBindings={},c.reactions={};const m={},n=new Map;if(b.data)for(f in b.data)if(g=b.data[f],m[f]=g.value,"object"==typeof g.value&&null!==g.value&&g.value.id===x.id?c.storeBindings[f]=g.value:"function"==typeof g.value?n.set(f,new K(f,g.value)):c.data[f]=g.value,g.reaction)if("string"==typeof g.reaction){if(!j[g.reaction])throw new Error(`No Reaction with name "${g.reaction}" exists.`);c.reactions[f]=j[g.reaction]}else if("function"==typeof g.reaction){if(j[f]||c.reactions[f])throw new Error(`A reaction for data property "${f}" has already been registered.`);c.reactions[f]=g.reaction}if(c.defaultAttributeValues={},c.attributeChangedCallbacks={},b.attributes)for(f in b.attributes){if(g=b.attributes[f],"undefined"!=typeof g.value)if("string"!=typeof g.value)throw new Error(`Attribute value for ${f} is not a String.`);else c.defaultAttributeValues[f]=g.value;if("string"==typeof g.reaction){if(!j[g.reaction])throw new Error(`No Reaction with name "${g.reaction}" exists.`);c.attributeChangedCallbacks[f]=j[g.reaction]}else"function"==typeof g.reaction&&(c.attributeChangedCallbacks[f]=g.reaction)}return c.computedProperties=L(m,n),c}function da(a,b,c){let d,e;for(d of c.entries())e=a.querySelector(d[1]),e[$]||(e[$]={},e.renderEach=ea),b[d[0]]=e;b.self=a}function ea(a,b,c=g){a||(a=[]);const d=this[$].childData||[];if(this[$].childData=a,0===a.length)(this[$].shadowDom||this).textContent="";else if(0===d.length){const c=this[$].shadowDom||this;for(let d=0;d<a.length;d++)c.appendChild(b(a[d]))}else fa(this[$].shadowDom||this,d,a,b,c)}function fa(c,d,e,f,g){let h,j,k,l=0,m=0,n=!0,o=d.length-1,p=e.length-1,q=c.firstChild,r=q,s=c.lastChild,t=s;outer:for(;n;){n=!1;let a;for(h=d[l],j=e[m];h===j;){if(g(q,j),l++,m++,r=q=q.nextSibling,o<l||p<m)break outer;h=d[l],j=e[m]}for(h=d[o],j=e[p];h===j;){if(g(s,j),o--,p--,k=s,t=s=s.previousSibling,o<l||p<m)break outer;h=d[o],j=e[p]}for(h=d[o],j=e[m];h===j;){if(n=!0,g(s,j),a=s.previousSibling,c.insertBefore(s,r),t=s=a,m++,o--,o<l||p<m)break outer;h=d[o],j=e[m]}for(h=d[l],j=e[p];h===j;){if(n=!0,g(q,j),a=q.nextSibling,c.insertBefore(q,k),k=t=q,q=a,l++,p--,o<l||p<m)break outer;h=d[l],j=e[p]}}if(p<m){if(l<=o)for(let a;l<=o;)0===o?c.removeChild(s):(a=s.previousSibling,c.removeChild(s),s=a),o--;return}if(o<l){if(m<=p)for(;m<=p;)k?c.insertBefore(f(e[m]),k):c.appendChild(f(e[m])),m++;return}const u=Array(p+1-m),v=new Map;let w;for(w=m;w<=p;w++)u[w]=-1,v.set(e[w],w);let x=0,y=[];for(w=l;w<=o;w++)v.has(d[w])?(u[v.get(d[w])]=w,x++):y.push(w);if(0==x){for(c.textContent="",w=m;w<=p;w++)c.appendChild(f(e[w]));return}const z=ga(u,m),A=[];let B=q;for(w=l;w<=o;w++)A[w]=B,B=B.nextSibling;for(w=0;w<y.length;w++)c.removeChild(A[y[w]]);let C,D=z.length-1;for(w=p;w>=m;w--)z[D]===w?(k=A[u[z[D]]],g(k,e[w]),D--):(-1===u[w]?C=f(e[w]):(C=A[u[w]],g(C,e[w])),c.insertBefore(C,k),k=C)}function ga(a,b){var c=Math.floor;const d=[],e=[],f=Array(a.length);let g,h,k,m=-1;for(g=b;g<a.length;g++){if(h=a[g],0>h)continue;let b,i=-1,j=d.length;if(0<j&&d[j-1]<=h)k=j-1;else{for(;1<j-i;)b=c((i+j)/2),d[b]>h?j=b:i=b;k=i}-1!==k&&(f[g]=e[k]),k===m?(m++,d[m]=h,e[m]=g):h<d[k+1]&&(d[k+1]=h,e[k+1]=g)}for(g=e[m];0<=m;g=f[g],m--)d[m]=g;return d}window.Cue={Server:c,Store:x,Component:ba};export{ba as Component,c as Server,x as Store};